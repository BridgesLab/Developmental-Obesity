---
title: "eTRF offspring body composition analysis"
author: "Molly C. Mulcahy"
date: "2/25/2021"
output:
  html_document: default
  pdf_document: default
---
#This document contains primary data and analysis for the dissertation work involving early time-restricted feeding during gestation effect on mouse offspring

#setup chunk
```{r setup, include=FALSE}
library(processx)
library(devtools)
library(dplyr)
library(readr)
library(car)
library(knitr)
library(tidyr)
library(lme4)
library(broom)
library(RCurl)
library(ggplot2)

#figures made will go to directory called figures, will make them as both png and pdf files 
opts_chunk$set(fig.path='figures/',
               echo=FALSE, warning=FALSE, message=FALSE,dev=c('png','pdf'))
options(scipen = 2, digits = 3)
# set echo and message to TRUE if you want to display code blocks and code output respectively
knitr::knit_hooks$set(inline = function(x) {
  knitr:::format_sci(x, 'md')
})
#write standard error function for later use
se <- function(x) sd(x, na.rm=T)/sqrt(length(x))
# sets color scheme for plots
color.scheme <- c('gray69','gray36')
```

#Data Entry
```{r data-entry-MRI}
MRI.data.file<-"MRI.Off.data.csv"
MRI.raw.data<-read_csv(MRI.data.file,
                       col_types = cols(
  ID = col_factor(levels = NULL),
  age = col_double(),
  animal.id = col_factor(levels = NULL),
  MouseID = col_factor(levels = NULL),
  Sex = col_factor(levels = c("M","F")),
  Genotype = col_factor(levels = NULL),
  values = col_double(),
  assay = col_factor(levels = NULL),
  experiment.date = col_date(format = ""),
  treatment = col_factor(levels = c("AL","eTRF")),
  dam = col_factor(levels = NULL),
  cohort = col_factor(levels = NULL),
  gram.values = col_double()))

MRI.raw.data<-MRI.raw.data%>%
  mutate(sex = case_when(
    Sex =="M"~"male",
    Sex=="F"~"female"))
```
#Pre-HFD analysis (PND 21- PND 70)
#Body Composition
```{r Figure2A}
#table of unique animals for body composition numbers
MRI.raw.data %>%
  group_by(sex,treatment) %>%
  distinct(ID, .keep_all = T) %>%
  count %>%
  kable(caption="Animals in each group of this cohort")
#Body Weight data table
BW.data<-filter(MRI.raw.data, assay=="Body Weight")%>%
  filter(age<70)%>%
  group_by(age, treatment, sex)%>%
  summarize_if(is.numeric, .funs = funs(mean=mean(.,na.rm = TRUE),se=se, n=length))
##Body Weight plot
ggplot(BW.data,aes(age, gram.values_mean, col = treatment))+
  geom_point(aes(col = treatment))+
  geom_smooth(span = 0.7,aes(col = treatment), se = FALSE)+
  facet_grid(.~sex)+
  scale_color_manual(values = color.scheme)+
  labs(title = "Offspring Body Weight", y = "Body weight (grams)",x="Age (days)")+
  theme(text = element_text(size=16),legend.position = c(0.9,0.19))

#all
BW.data.all<-MRI.raw.data%>%
  filter(assay=="Body Weight")%>%
   filter(age<70)

null.bw.lme<-lmer(gram.values ~ 1 + (1|MouseID) + (1|dam), data = BW.data.all)
age.bw.lme<-lmer(gram.values ~ age + (1|MouseID) + (1|dam), data = BW.data.all)
anova(null.bw.lme, age.bw.lme)#significant effect of age
diet.bw.lme<-lmer(gram.values ~ treatment+age +age:treatment + (1|MouseID) + (1|dam), data = BW.data.all)

sex.bw.lme<-lmer(gram.values~ age + treatment*sex +(1|MouseID) + (1|dam), data = BW.data.all) 
anova(sex.bw.lme, diet.bw.lme)#p<0.0001
Anova(sex.bw.lme)%>%tidy()%>%kable()
anova(age.bw.lme, diet.bw.lme)%>%tidy()%>%kable()
#anova(diet.bw.lme.f)%>%tidy%>%filter(term =="age:treatment")%>%pull(p.value)
```
There is a significant interaction of age and treatment in females where age-matched AL female have a ,p-value.

```{r Fig2C}
#Lean Mass data table
LM.data<-filter(MRI.raw.data, assay=="Lean Mass")%>%
  filter(age<70)%>%
  group_by(age, treatment, sex)%>%
  summarize_if(is.numeric, .funs = funs(mean=mean(.,na.rm = TRUE),se=se, n=length))
#Lean Mass Plot
ggplot(LM.data,aes(age, gram.values_mean, col = treatment))+
  geom_point(aes(col = treatment))+
  geom_smooth(span = 0.7,aes(col = treatment), se = FALSE)+
  facet_grid(.~sex)+
  scale_color_manual(values = color.scheme)+
  labs(title = "Offspring Lean Mass", y = "Lean Mass (grams)",x="Age (days)")+
  theme(text = element_text(size=16),legend.position = c(0.9,0.80))

#stats
LM.data.all<-MRI.raw.data%>%
  filter(assay=="Lean Mass")%>%
   filter(age<70)

null.lm.lme<-lmer(gram.values ~ 1 + (1|MouseID) + (1|dam), data = LM.data.all)
age.lm.lme<-lmer(gram.values ~ age + (1|MouseID) + (1|dam), data = LM.data.all)
anova(null.lm.lme, age.lm.lme)#significant effect of age
diet.lm.lme<-lmer(gram.values ~ treatment+age +age:treatment + (1|MouseID) + (1|dam), data = LM.data.all)
anova(age.lm.lme, diet.lm.lme)%>%tidy()%>%kable()
sex.lm.lme<-lmer(gram.values~ age + treatment*sex +(1|MouseID) + (1|dam), data = LM.data.all)
anova(sex.lm.lme, diet.lm.lme)#p<0.0001
Anova(sex.lm.lme)%>%tidy()%>%kable()
```

```{r Fig2B}
#Body Fat Data table
FM.data<-filter(MRI.raw.data, assay=="Total Fat Mass")%>%
  filter(age<70)%>%
  group_by(age, treatment, sex)%>%
  summarize_if(is.numeric, .funs = funs(mean=mean(.,na.rm = TRUE),se=se, n=length))
#Body Fat Plot
ggplot(FM.data,aes(age, gram.values_mean, col = treatment))+
  geom_point(aes(col = treatment))+
  geom_smooth(span = 0.7,aes(col = treatment), se = FALSE)+
  facet_grid(.~sex)+
  scale_color_manual(values = color.scheme)+
  labs(title = "Offspring Fat Mass", y = "Fat Mass (grams)",x="Age (days)")+
  theme(text = element_text(size=16),legend.position = c(0.9,0.80))
#Stats
FM.data.all<-MRI.raw.data%>%
  filter(assay=="Total Fat Mass")%>%
   filter(age<70)

null.fm.lme<-lmer(gram.values ~ 1 + (1|MouseID) + (1|dam), data = FM.data.all)
age.fm.lme<-lmer(gram.values ~ age + (1|MouseID) + (1|dam), data = FM.data.all)
anova(null.fm.lme, age.fm.lme)#significant effect of age
sex.fm.lme<-lmer(gram.values~ age + treatment*sex +(1|MouseID) + (1|dam), data = FM.data.all)
diet.fm.lme<-lmer(gram.values ~ treatment +age +treatment:age+ (1|MouseID) + (1|dam), data = FM.data.all)
anova(sex.fm.lme, diet.fm.lme)#p=0.0038
Anova(sex.bw.lme)%>%tidy()%>%kable()
```
#Food Intake Data
```{r data-entry-intake}
intake.data.raw<-("Intake.Off.data.csv")
intake.data<-read_csv(intake.data.raw,
                      col_types = cols(
                        cage = col_factor(levels = NULL),
                        "# in cage" = col_double(),
                        week = col_integer(),
                        "IDs" = col_factor(levels = NULL),
                        start = col_double(),
                        end=col_double(),
                        date = col_character(),
                        notes = col_factor(levels=NULL),
                        diet = col_factor(levels = NULL),
                        cohort = col_factor(levels = NULL),
                        food.consumed = col_double(),
                        kcals.consumed = col_double(),
                        food.cumulative = col_double(),
                        treatment = col_factor(levels = c("eTRF","AL")),
                        sex = col_factor(levels = c("female","male"))
                        ))
```

#Food Intake
```{r Fig2D}
#Table of Cages in Food Intake Analyses
intake.data %>%
  group_by(sex,treatment) %>%
  distinct(cage, .keep_all = T) %>%
  count %>%
  kable(caption="Cages in each group")

#make averaged dataset
average.intake<-intake.data%>%
   filter(!(week=="5"&cage=="2031"))%>%
   filter(!(week=="6"&cage=="2031"))%>%
   filter(!(week=="7"&cage=="2031"))%>%
  group_by(week, diet, treatment, sex)%>%
  summarize_if(is.numeric, .funs = funs(mean=mean(.,na.rm = TRUE),se=se, n=length))

#Filter out HFD from dataset
Pre.HFD.data<-average.intake%>%
  filter(diet=="NCD")

intake.data.NCD<-intake.data%>%
  filter(diet=="NCD")

#Plot of averaged.intake
ggplot(Pre.HFD.data, aes(week, kcals.consumed_mean,col = treatment))+
  geom_point(aes(col = treatment))+
  geom_smooth(aes(col = treatment), se=FALSE, span =0.7)+
  geom_errorbar(aes(ymin = kcals.consumed_mean -kcals.consumed_se, ymax = kcals.consumed_mean +kcals.consumed_se), width = 0.3)+
  facet_grid(.~sex)+
  labs(title="Weekly Food Intake", y = "Food Intake (kcals)", x="Week")+
  scale_color_manual(values = color.scheme)+
   theme(text = element_text(size=16),legend.position = c(0.1,0.80))

##all

null.week.food.lme<-lmer(kcals.consumed ~ 1 + (1|cage), intake.data.NCD)
age.week.food.lme<-lmer(kcals.consumed ~ week + (1|cage), intake.data.NCD)
anova(null.week.food.lme, age.week.food.lme)# age p=0.0001
group.week.food.lme<-lmer(kcals.consumed~ week*treatment +(1|cage), intake.data.NCD)
anova(age.week.food.lme, group.week.food.lme)# effect of group in female(p=0.049)

##Female
intake.data.NCD.F<-intake.data.NCD%>%
  filter(sex=="female")

null.week.food.lme.F<-lmer(kcals.consumed ~ 1 + (1|cage), intake.data.NCD.F)
age.week.food.lme.F<-lmer(kcals.consumed ~ week + (1|cage), intake.data.NCD.F)
anova(null.week.food.lme.F, age.week.food.lme.F)# no effect of age,p= 0.068
group.week.food.lme.F<-lmer(kcals.consumed~ week*treatment +(1|cage), intake.data.NCD.F)
anova(age.week.food.lme.F, group.week.food.lme.F)# effect of group in female(p=0.049)
fixef(group.week.food.lme.F)
##Male
intake.data.NCD.M<-intake.data.NCD%>%
  filter(sex=="male")

null.week.food.lme.M<-lmer(kcals.consumed ~ 1 + (1|cage), intake.data.NCD.M)
age.week.food.lme.M<-lmer(kcals.consumed ~ week + (1|cage), intake.data.NCD.M)
anova(null.week.food.lme.M, age.week.food.lme.M)# effect of age,p= 0.00079
group.week.food.lme.M<-lmer(kcals.consumed~ week*treatment +(1|cage), intake.data.NCD.M)
anova(age.week.food.lme.M, group.week.food.lme.M)# no effect of group in male(p=0.60)
fixef(group.week.food.lme.M)
```


```{r fig2E}
#cumulative intake plot
ggplot(Pre.HFD.data, aes(week, food.cumulative_mean, col = treatment))+
  geom_point(aes(col = treatment))+
  geom_smooth(aes(col = treatment), se=FALSE)+
  geom_errorbar(aes(ymin = food.cumulative_mean -food.cumulative_se, ymax = food.cumulative_mean +food.cumulative_se), width = 0.3)+
  facet_grid(.~sex)+
  labs(x="Week",y="Cumulative Food Intake (kcals)")+
  ggtitle("Cumulative Food Intake")+
  scale_color_manual(values = color.scheme)+
  theme(text = element_text(size=16),legend.position = c(0.1,0.80))

#statistics for cumulative food intake
null.cumu.food.lme<-lmer(food.cumulative ~ 1 + (1|cage), intake.data.NCD)
age.cumu.food.lme<-lmer(food.cumulative~ week + (1|cage), intake.data.NCD)
anova(null.cumu.food.lme, age.cumu.food.lme)# effect of age,p< 0.0001
group.cumu.food.lme<-lmer(food.cumulative~ week+ treatment +(1|cage), intake.data.NCD)
sex.cumu.food.lme<-lmer(food.cumulative~ week+ treatment*sex +(1|cage), intake.data.NCD)
anova(group.cumu.food.lme, sex.cumu.food.lme)#p=0.065
Anova(sex.cumu.food.lme)
Anova(group.cumu.food.lme)$p.value
fixef(group.cumu.food.lme)
```

```{r Fig2F}
NCD.ITT.raw.data<-read_csv("NCD.ITT.Offspring.csv",
                           col_types = cols(
                             ID = col_factor(levels = NULL),
                             cage = col_factor(levels = NULL),
                             time = col_integer(),
                             glucose = col_double(),
                             treatment = col_factor(levels = c("eTRF","AL")),
                             sex = col_factor(levels = c("female","male")),
                             cohort = col_factor(levels = NULL),
                             dam = col_factor(levels = NULL),
                             rel.glucose = col_double()
                           ))

NCD.ITT.raw.data<-NCD.ITT.raw.data%>%
  group_by(ID)%>%
  mutate(AUC = sum(glucose))

summary.ITT<-NCD.ITT.raw.data%>%
  group_by(sex, time, treatment)%>%
  summarise_if(is.numeric, .funs = funs(mean=mean(.,na.rm = TRUE),se=se, n=length))

#plot, time course
ggplot(summary.ITT, aes(time, glucose_mean))+
  geom_point(aes(col = treatment))+
  geom_smooth(aes(col = treatment), se = FALSE)+
  geom_errorbar(aes(ymin = glucose_mean -glucose_se, ymax = glucose_mean + glucose_se))+
  facet_grid(.~sex)+
  scale_color_manual(values = color.scheme )+
  labs(title = "Insulin Tolerance Test", y = "Blood Glucose (mg/dL)", x = "Time (minutes)")+
   theme(text = element_text(size=16),legend.position = c(0.9,0.80))

#Stats

##all

null.NCDITT.lme<-lmer(glucose ~ 1 + (1|ID) + (1|dam), data = NCD.ITT.raw.data)
age.NCDITT.lme <-lmer(glucose ~ time + (1|ID) + (1|dam), data = NCD.ITT.raw.data)
anova(null.NCDITT.lme, age.NCDITT.lme)#significant, p<0.0001
diet.NCDITT.lme<-lmer(glucose ~ time + treatment + time:treatment + (1|ID) + (1|dam), data = NCD.ITT.raw.data)
anova(age.NCDITT.lme, diet.NCDITT.lme)# p=0.015
sex.NCDITT.lme<-lmer(glucose ~ time +  sex*treatment + (1|ID) + (1|dam), data = NCD.ITT.raw.data)
anova(diet.NCDITT.lme, sex.NCDITT.lme)#significant
Anova(sex.NCDITT.lme)
fixef(sex.NCDITT.lme)
```
```{r AUC-ITT-NCD}
#plot AUC
AUC.NCD.ITT.summary<-NCD.ITT.raw.data%>%
  group_by(treatment, sex)%>%
   summarise_if(is.numeric, .funs = funs(mean=mean(.,na.rm = TRUE),se=se, n=length))

ggplot(AUC.NCD.ITT.summary, aes(treatment,AUC_mean))+
  geom_col(aes(fill = treatment))+
  geom_errorbar(aes(ymin = AUC_mean -AUC_se, ymax = AUC_mean + AUC_se), width = 0.3)+
  facet_grid(.~sex)+
  scale_fill_manual(values = color.scheme )+
  labs(title = "ITT Area Under the Curve", y = "Avg AUC (mg/dL)")+
   theme(text = element_text(size=16),legend.position = c(0.9,0.20))
#AUC stats
ITT.AUC.NCD.aov<-aov(AUC ~treatment + sex , NCD.ITT.raw.data)# no interaction
Anova(ITT.AUC.NCD.aov)
```

```{r Fig2G}
   #FBG
  FBG.data<- NCD.ITT.raw.data%>%
     filter(time=="0")%>%
    group_by(sex, treatment)%>%
    summarise_if(is.numeric, .funs = funs(mean=mean(.,na.rm = TRUE),se=se, n=length))
  #FBG plot
  ggplot(FBG.data, aes(treatment, glucose_mean, fill = treatment))+
    geom_col(aes(fill = treatment))+
    facet_grid(.~sex)+
    geom_errorbar(aes(ymin = glucose_mean -glucose_se, ymax = glucose_mean + glucose_se), width = 0.3)+
    scale_fill_manual(values = color.scheme)+
    labs(title = "Fasting Blood Glucose", y = "Blood Glucose (mg/dL)")+
   theme(text = element_text(size=16),legend.position = c(0.9,0.20))
  
  #stats
  
  ##ALL
  FBG.stats<-NCD.ITT.raw.data%>%
     filter(time=="0")
  
  FBG.ITT.NCD.aov<-aov(glucose~ treatment+sex, FBG.stats)#no interaction
  anova(FBG.ITT.NCD.aov)
coefficients(FBG.ITT.NCD.aov)
```

```{r Fig2H}
NCD.GTT.data.file<-"NCD.GTT.raw.data.csv"
NCD.GTT.raw.data<-read_csv(NCD.GTT.data.file,
    col_types = cols(
  ID = col_factor(levels = NULL),
  time = col_integer(),
  glucose = col_double(),
  cage = col_factor(levels = NULL),
  dam = col_factor(levels = NULL),
  sex = col_factor(levels = NULL),
  treatment = col_factor(levels = c("eTRF","AL")),
  cohort = col_factor(levels = NULL)
  ))

NCD.GTT.raw.data<-NCD.GTT.raw.data%>%
  group_by(ID)%>%
  mutate(AUC = sum(glucose))
#Summary data set
summary.GTT<-NCD.GTT.raw.data%>%
  group_by(sex, time, treatment)%>%
  summarise_if(is.numeric, .funs = funs(mean=mean(.,na.rm = TRUE),se=se, n=length))

NCD.GTT.raw.data %>%
  group_by(sex,treatment) %>%
  distinct(ID, .keep_all = T) %>%
  count %>%
  kable(caption="IDS in each group")

#plot, time course
ggplot(summary.GTT, aes(time, glucose_mean))+
  geom_point(aes(col = treatment))+
  geom_smooth(aes(col = treatment), se = FALSE)+
  geom_errorbar(aes(ymin = glucose_mean -glucose_se, ymax = glucose_mean + glucose_se))+
  facet_grid(.~sex)+
  scale_color_manual(values = color.scheme )+
  labs(title = "Glucose Tolerance Test", y = "Blood Glucose (mg/dL)", x = "Time (minutes)")+
   theme(text = element_text(size=16),legend.position = c(0.4,0.80))

#Stats
##ALl
null.NCDGTT.lme<-lmer(glucose ~ 1 + (1|ID) + (1|dam), data = NCD.GTT.raw.data)
age.NCDGTT.lme <-lmer(glucose ~ time + (1|ID) + (1|dam), data = NCD.GTT.raw.data)
anova(null.NCDGTT.lme, age.NCDGTT.lme)#significant effect of time, p<0.0001
diet.NCDGTT.lme<-lmer(glucose ~ time + treatment  + (1|ID) + (1|dam), data = NCD.GTT.raw.data)
anova(age.NCDGTT.lme, diet.NCDGTT.lme)# p=0.22, no effect of treatment
sex.NCDGTT.lme<-lmer(glucose ~ time +  sex*treatment + (1|ID) + (1|dam), data = NCD.GTT.raw.data)
anova(diet.NCDGTT.lme, sex.NCDGTT.lme)#p=0.32
Anova(sex.NCDGTT.lme)
fixef(diet.NCDGTT.lme)
```

```{r AUCGTTNCD}
#plot AUC
AUC.NCD.GTT.summary<-NCD.GTT.raw.data%>%
  group_by(treatment, sex)%>%
   summarise_if(is.numeric, .funs = funs(mean=mean(.,na.rm = TRUE),se=se, n=length))

ggplot(AUC.NCD.GTT.summary, aes(treatment, AUC_mean))+
  geom_col(aes(fill = treatment))+
  geom_errorbar(aes(ymin = AUC_mean -AUC_se, ymax = AUC_mean + AUC_se), width = 0.3)+
  facet_grid(.~sex)+
  scale_fill_manual(values = color.scheme )+
  labs(title = "GTT Area Under the Curve", y = "Avg AUC (mg/dL)")+
   theme(text = element_text(size=16),legend.position = c(0.9,0.20))
#AUC stats
GTT.AUC.NCD.aov<-aov(AUC ~treatment * sex , NCD.GTT.raw.data)# significant interaction
Anova(GTT.AUC.NCD.aov)

```
#Post HFD analysis(PND 70-sacrifice)

```{r Fig3A}
#Body Weight data table
BW.data.HFD<-filter(MRI.raw.data, assay=="Body Weight")%>%
  filter(age>=70)%>%
  group_by(age, treatment, sex)%>%
  summarize_if(is.numeric, .funs = funs(mean=mean(.,na.rm = TRUE),se=se, n=length))

##Body Weight plot
ggplot(BW.data.HFD,aes(age, gram.values_mean, col = treatment))+
  geom_point(aes(col = treatment))+
  geom_smooth(span = 0.7,aes(col = treatment), se = FALSE)+
  facet_grid(.~sex)+
  scale_color_manual(values = c("gray36", "gray69"))+
  labs(title = "Offspring Body Weight", y = "Body weight (grams)",x="Age (days)")+
  theme(text = element_text(size=16),legend.position = c(0.9,0.19))

#ALL
HFD.BW.data<-MRI.raw.data%>%
  filter(age>=70)%>%
  filter(assay=="Body Weight")


#mixed linear models
HFD.null.bw.lme<-lmer(gram.values ~ 1 + (1|MouseID) + (1|dam), data = HFD.BW.data)
HFD.age.bw.lme <-lmer(gram.values ~ age + (1|MouseID) + (1|dam), data = HFD.BW.data)
anova(HFD.null.bw.lme, HFD.age.bw.lme)#significant effect of age
HFD.diet.bw.lme<-lmer(gram.values ~ treatment+age +age:treatment + (1|MouseID) + (1|dam), data = HFD.BW.data)
anova(HFD.age.bw.lme, HFD.diet.bw.lme)#sig with interaction
Anova(HFD.diet.bw.lme)
HFD.sex.bw.lme<-lmer(gram.values ~ age +sex +treatment + (1|MouseID) + (1|dam), data = HFD.BW.data)
anova(HFD.diet.bw.lme, HFD.sex.bw.lme)#significant, but no interaction between sex and treatment
Anova(HFD.sex.bw.lme)# no interaction of sex and treatment, so removed, 

```


```{r Fig3B}
#Fat Mass data table
FM.data.HFD<-filter(MRI.raw.data, assay=="Total Fat Mass")%>%
  filter(age>=70)%>%
  group_by(age, treatment, sex)%>%
  summarize_if(is.numeric, .funs = funs(mean=mean(.,na.rm = TRUE),se=se, n=length))

##Fat Mass plot
ggplot(FM.data.HFD,aes(age, gram.values_mean, col = treatment))+
  geom_point(aes(col = treatment))+
  geom_smooth(span = 0.7,aes(col = treatment), se = FALSE)+
  facet_grid(.~sex)+
  scale_color_manual(values = c("gray36", "gray69"))+
  labs(title = "Offspring Fat Mass", y = "Fat Mass (grams)",x="Age (days)")+
  theme(text = element_text(size=16),legend.position = c(0.9,0.19))

#All
HFD.FM.data<-MRI.raw.data%>%
  filter(age>=70)%>%
  filter(assay=="Total Fat Mass")

HFD.null.fm.lme<-lmer(gram.values ~ 1 + (1|MouseID) + (1|dam), data = HFD.FM.data)
HFD.age.fm.lme <-lmer(gram.values ~ age + (1|MouseID) + (1|dam), data = HFD.FM.data)
anova(HFD.null.fm.lme, HFD.age.fm.lme)#significant effect of age
HFD.diet.fm.lme<-lmer(gram.values ~ treatment+age +age:treatment + (1|MouseID) + (1|dam), data = HFD.FM.data)
anova(HFD.age.fm.lme, HFD.diet.fm.lme)#sig with interaction, p=0.00011
Anova(HFD.diet.fm.lme)
HFD.sex.fm.lme<-lmer(gram.values ~ age +sex*treatment + (1|MouseID) + (1|dam), data = HFD.FM.data)
anova(HFD.diet.fm.lme, HFD.sex.fm.lme)#significant, but no interaction between sex and treatment
Anova(HFD.sex.fm.lme)# no interaction of sex and treatment, so removed, 
```

```{r Fig3C}
#Lean Mass data table
LM.data.HFD<-filter(MRI.raw.data, assay=="Lean Mass")%>%
  filter(age>=70)%>%
  group_by(age, treatment, sex)%>%
  summarize_if(is.numeric, .funs = funs(mean=mean(.,na.rm = TRUE),se=se, n=length))

##Lean Mass plot
ggplot(LM.data.HFD,aes(age, gram.values_mean, col = treatment))+
  geom_point(aes(col = treatment))+
  geom_smooth(span = 0.7,aes(col = treatment), se = FALSE)+
  facet_grid(.~sex)+
  scale_color_manual(values = c("gray36", "gray69"))+
  labs(title = "Offspring Lean Mass", y = "Lean Mass (grams)",x="Age (days)")+
  theme(text = element_text(size=16),legend.position = c(0.9,0.19))
#stats
HFD.LM.data<-MRI.raw.data%>%
  filter(age>=70)%>%
  filter(assay=="Lean Mass")

HFD.null.lm.lme<-lmer(gram.values ~ 1 + (1|MouseID) + (1|dam), data = HFD.LM.data)
HFD.age.lm.lme <-lmer(gram.values ~ age + (1|MouseID) + (1|dam), data = HFD.LM.data)
anova(HFD.null.lm.lme, HFD.age.lm.lme)#significant effect of age
HFD.diet.lm.lme<-lmer(gram.values ~ treatment+age +age:treatment + (1|MouseID) + (1|dam), data = HFD.LM.data)
anova(HFD.age.lm.lme, HFD.diet.lm.lme)# not sig with interaction, p=0.13
HFD.sex.lm.lme<-lmer(gram.values ~ age +sex*treatment + (1|MouseID) + (1|dam), data = HFD.LM.data)
anova(HFD.diet.lm.lme, HFD.sex.lm.lme)#significant, but no interaction between sex and treatment
Anova(HFD.sex.lm.lme)# no interaction of sex and treatment, so removed, 
```

```{r Fig3D}
#Filter out NCD from dataset
HFD.data<-average.intake%>%
  filter(diet=="HFD")

intake.data.HFD<-intake.data%>%
  filter(diet=="HFD")

#Plot of averaged.intake
ggplot(HFD.data, aes(week, kcals.consumed_mean,col = treatment))+
  geom_point(aes(col = treatment))+
  geom_smooth(aes(col = treatment), se=FALSE, span =0.7)+
  geom_errorbar(aes(ymin = kcals.consumed_mean -kcals.consumed_se, ymax = kcals.consumed_mean +kcals.consumed_se), width = 0.3)+
  facet_grid(.~sex)+
  labs(title="Weekly Food Intake", y = "Food Intake (kcals)", x="Week")+
  scale_color_manual(values = color.scheme)+
   theme(text = element_text(size=16),legend.position = c(0.9,0.80))

#stats
intake.data.HFD.F<-intake.data.HFD%>%
  filter(sex=="female")

null.week.HFD.food.lme.F<-lmer(kcals.consumed ~ 1 + (1|cage), intake.data.HFD.F)
age.week.HFD.food.lme.F<-lmer(kcals.consumed ~ week + (1|cage), intake.data.HFD.F)
#anova(null.week.HFD.food.lme.F, age.week.HFD.food.lme.F)# no effect of age,p= 0.068
group.week.HFD.food.lme.F<-lmer(kcals.consumed~ week*treatment +(1|cage), intake.data.HFD.F)
anova(age.week.HFD.food.lme.F, group.week.HFD.food.lme.F)# no effect of group in female(p=0.76)
fixef(group.week.HFD.food.lme.F)
##Male
intake.data.HFD.M<-intake.data.HFD%>%
  filter(sex=="male")

null.week.HFD.food.lme.M<-lmer(kcals.consumed ~ 1 + (1|cage), intake.data.HFD.M)
age.week.HFD.food.lme.M<-lmer(kcals.consumed ~ week + (1|cage), intake.data.HFD.M)
#anova(null.week.HFD.food.lme.M, age.week.HFD.food.lme.M)# no effect of age,p= 0.068
group.week.HFD.food.lme.M<-lmer(kcals.consumed~ week*treatment +(1|cage), intake.data.HFD.M)
anova(age.week.HFD.food.lme.M, group.week.HFD.food.lme.M)# no effect of group in female(p=0.57)
fixef(group.week.HFD.food.lme.M)
```


```{r Fig3E}

HFD.data.filtered<-HFD.data%>%
  filter(!(week == 15))
#Plot of  cumulative intake
ggplot(HFD.data.filtered, aes(week, food.cumulative_mean,col = treatment))+
  geom_point(aes(col = treatment))+
  geom_smooth(aes(col = treatment), se=FALSE, span =0.7)+
  geom_errorbar(aes(ymin = food.cumulative_mean -food.cumulative_se, ymax = food.cumulative_mean +food.cumulative_se), width = 0.3)+
  facet_grid(.~sex)+
  labs(title="Cumulative Food Intake", y = "Cumulative Food Intake (kcals)", x="Week")+
  scale_color_manual(values = color.scheme)+
   theme(text = element_text(size=16),legend.position = c(0.1,0.80))

#statistics
##ALL

#statistics for cumulative food intake
null.cumu.HFD.food.lme<-lmer(food.cumulative ~ 1 + (1|cage), intake.data.HFD)
age.cumu.HFD.food.lme<-lmer(food.cumulative ~ week + (1|cage), intake.data.HFD)
#anova(null.cumu.HFD.food.lme, age.cumu.HFD.food.lme)# effect of age,p< 0.0001
group.cumu.HFD.food.lme<-lmer(food.cumulative~ week+ treatment +(1|cage), intake.data.HFD)
anova(age.cumu.HFD.food.lme, group.cumu.HFD.food.lme)#p=0.5
sex.cumu.HFD.food.lme<-lmer(food.cumulative~ week+ treatment*sex +(1|cage), intake.data.HFD)
anova(group.cumu.HFD.food.lme, sex.cumu.HFD.food.lme)#p=0.91, no interaction
Anova(sex.cumu.food.lme)
```


```{r Fig3F}
#High fat diet Insulin tolerance test
HFD.ITT.file <-"HFD.ITT.Offspring.csv"
HFD.ITT.raw.data<-read_csv(HFD.ITT.file,
                           col_types = cols(
                             cage = col_factor(levels = NULL),
                               ID = col_factor(levels = NULL),
                               time = col_integer(),
                               glucose = col_double(),
                               crash = col_factor(levels = NULL),
                               dam = col_factor(levels = NULL),
                               cohort = col_factor(levels = NULL),
                               treatment = col_factor(levels = c("eTRF","AL")),
                               sex = col_factor(levels = c("female","male")),
                               rel.glucose = col_double()
                           ))
HFD.ITT.raw.data<-HFD.ITT.raw.data%>%
  group_by(ID)%>%
  mutate(AUC = sum(glucose))

#Summary data set
summary.HFD.ITT<-HFD.ITT.raw.data%>%
  group_by(sex, time, treatment)%>%
  summarise_if(is.numeric, .funs = funs(mean=mean(.,na.rm = TRUE),se=se, n=length))

HFD.ITT.raw.data %>%
  group_by(sex,treatment) %>%
  distinct(ID, .keep_all = T) %>%
  count %>%
  kable(caption="IDS in each group")

#plot, time course
ggplot(summary.HFD.ITT, aes(time, glucose_mean))+
  geom_point(aes(col = treatment))+
  geom_line(aes(col = treatment))+
  geom_errorbar(aes(ymin = glucose_mean - glucose_se, ymax = glucose_mean + glucose_se))+
  facet_grid(.~sex)+
  scale_color_manual(values = color.scheme )+
  labs(title = "Insulin Tolerance Test", y = "Blood Glucose (mg/dL)", x = "Time (minutes)")+
   theme(text = element_text(size=16),legend.position = c(0.4,0.80))

#Stats
##all
null.HFD.ITT.lme<-lmer(glucose ~ 1 + (1|ID) + (1|dam), data = HFD.ITT.raw.data)
age.HFD.ITT.lme <-lmer(glucose ~ time + (1|ID) + (1|dam), data = HFD.ITT.raw.data)
#anova(null.HFD.ITT., age.HFD.ITT.lme)#significant effect of time, p<0.0001
diet.HFD.ITT.lme<-lmer(glucose ~ time + treatment  + (1|ID) + (1|dam), data = HFD.ITT.raw.data)
anova(age.HFD.ITT.lme, diet.HFD.ITT.lme)# p=0.068, no effect of treatment
sex.HFD.ITT.lme<-lmer(glucose ~ time +  sex*treatment + (1|ID) + (1|dam), data = HFD.ITT.raw.data)
anova(diet.HFD.ITT.lme, sex.HFD.ITT.lme)#significant
Anova(sex.HFD.ITT.lme)
fixef(diet.HFD.ITT.lme)

#significant interaction, analyze by each sex
##Males
HFD.ITT.M<-HFD.ITT.raw.data%>%
  filter(sex == "male")

null.HFD.ITT.lme.m<-lmer(glucose ~ 1 + (1|ID) + (1|dam), data = HFD.ITT.M)
age.HFD.ITT.lme.m <-lmer(glucose ~ time + (1|ID) + (1|dam), data = HFD.ITT.M)
anova(null.HFD.ITT.lme.m, age.HFD.ITT.lme.m)#significant, p=0.0062
diet.HFD.ITT.lme.m<-lmer(glucose ~ time + treatment + time:treatment + (1|ID) + (1|dam), data = HFD.ITT.M)
anova(age.HFD.ITT.lme.m, diet.HFD.ITT.lme.m)# p=0.17
fixef(diet.HFD.ITT.lme.m)
##females
HFD.ITT.F<-HFD.ITT.raw.data%>%
  filter(sex == "female")
null.HFD.ITT.lme.f<-lmer(glucose ~ 1 + (1|ID) + (1|dam), data = HFD.ITT.F)
age.HFD.ITT.lme.f <-lmer(glucose ~ time + (1|ID) + (1|dam), data = HFD.ITT.F)
anova(null.HFD.ITT.lme.f, age.HFD.ITT.lme.f)#significant, p=0.0062
diet.HFD.ITT.lme.f<-lmer(glucose ~ time + treatment + time:treatment + (1|ID) + (1|dam), data = HFD.ITT.F)
anova(age.HFD.ITT.lme.f, diet.HFD.ITT.lme.f)# p=0.85
fixef(diet.HFD.ITT.lme.f)
```

```{r AUC-HFD-ITT}
AUC.ITT.HFD.summary<-HFD.ITT.raw.data%>%
  group_by(treatment, sex)%>%
  summarise_if(is.numeric, .funs = funs(mean=mean(.,na.rm = TRUE),se=se, n=length))
ggplot( AUC.ITT.HFD.summary,aes(treatment, AUC_mean))+
  geom_col(aes(fill = treatment))+
  geom_errorbar(aes(ymin = AUC_mean - AUC_se, ymax = AUC_mean + AUC_se), width = 0.3)+
  facet_grid(.~sex)+
  scale_fill_manual(values = color.scheme )+
  labs(title = "Glucose Area Under the Curve", y = " Avg Blood Glucose (mg/dL)")+
   theme(text = element_text(size=16),legend.position = c(0.4,0.80))

##stats
HFD.ITT.AUC.aov<-aov(AUC~sex*treatment, HFD.ITT.raw.data)# effect of interaction
anova(HFD.ITT.AUC.aov)#significant interaction, sex specific needed

#females
HFD.ITT.raw.data.F<-HFD.ITT.raw.data%>%
  filter(sex =="female")

#shapiro.test(HFD.ITT.raw.data.F$AUC[HFD.ITT.raw.data.F$treatment =="eTRF"])#not normal
#shapiro.test(HFD.ITT.raw.data.F$AUC[HFD.ITT.raw.data.F$treatment =="AL"])#not normal
#leveneTest(AUC~treatment, HFD.ITT.raw.data.F)#non-equivalent variance
#Mann-Whitney U test
#wilcox.test(AUC~treatment, HFD.ITT.raw.data.F)#p=0.2
#males
HFD.ITT.raw.data.M<-HFD.ITT.raw.data%>%
  filter(sex =="male")

#shapiro.test(HFD.ITT.raw.data.M$AUC[HFD.ITT.raw.data.M$treatment =="eTRF"])#not normal
#shapiro.test(HFD.ITT.raw.data.M$AUC[HFD.ITT.raw.data.M$treatment =="AL"])#not normal
#leveneTest(AUC~treatment, HFD.ITT.raw.data.M)#equivalent variance
#Mann-Whitney U test
#wilcox.test(AUC~treatment, HFD.ITT.raw.data.M)$p.value#p=0.000000016
```

```{r Fig3G}
#generate HFD ITT data set
HFD.FBG.data<-HFD.ITT.raw.data%>%
  filter(time=="0")
#HFD ITT summary data set
summary.HFD.FBG<-HFD.FBG.data%>%
  group_by(sex, treatment)%>%
  summarise_if(is.numeric, .funs = funs(mean=mean(.,na.rm = TRUE),se=se, n=length))

#plot
ggplot(summary.HFD.FBG,  aes(treatment, glucose_mean, fill = treatment))+
  geom_col(aes(fill = treatment))+
  facet_grid(.~sex)+
  scale_fill_manual(values = color.scheme)+
  geom_errorbar(aes(ymin = glucose_mean - glucose_se, ymax = glucose_mean + glucose_se), width = 0.3)+
  labs(title = "Fasting Blood Glucose", y = "Blood Glucose (mg/dL)")+
   theme(text = element_text(size=16),legend.position = c(0.9,0.20))

 #stats

HFD.FBG.aov<-aov(glucose~ sex+treatment,HFD.FBG.data)#no interaction
anova(HFD.FBG.aov)#sig of sex, not treatment 
```
```{r Fig3H}
#Glucose tolerance test
HFD.GTT.file<-"HFD.GTT.Offspring.csv"
HFD.GTT.raw.data<-read_csv(HFD.GTT.file,
                           col_types = cols(
                             cage = col_factor(levels = NULL),
                               ID = col_factor(levels = NULL),
                               time = col_integer(),
                               glucose = col_double(),
                               dam = col_factor(levels = NULL),
                               cohort = col_factor(levels = NULL),
                               treatment = col_factor(levels = c("eTRF","AL")),
                               sex = col_factor(levels = c("female","male")),
                               rel.glucose = col_double()
                           ))
HFD.GTT.raw.data<-HFD.GTT.raw.data%>%
  group_by(ID)%>%
  mutate(AUC = sum(glucose))

##summary dataset
summary.HFD.GTT<-HFD.GTT.raw.data%>%
  group_by(sex, treatment, time)%>%
  summarise_if(is.numeric, .funs = funs(mean=mean(.,na.rm = TRUE),se=se, n=length))

#Plot
ggplot(summary.HFD.GTT, aes(time, glucose_mean, col = treatment))+
  geom_point(aes(col = treatment))+
  geom_line(aes(col = treatment))+
  geom_errorbar(aes(ymin = glucose_mean - glucose_se, ymax = glucose_mean + glucose_se))+
  facet_grid(.~sex)+
  scale_color_manual(values = color.scheme )+
  labs(title = "Glucose Tolerance Test", y = "Blood Glucose (mg/dL)", x = "Time (minutes)")+
   theme(text = element_text(size=16),legend.position = c(0.4,0.80))

#Stats
##ALL

null.HFD.GTT.lme<-lmer(glucose ~ 1 + (1|ID) + (1|dam), data = HFD.GTT.raw.data)
age.HFD.GTT.lme <-lmer(glucose ~ time + (1|ID) + (1|dam), data = HFD.GTT.raw.data)
anova(null.HFD.GTT.lme, age.HFD.GTT.lme)#significant effect of time, p=0.0062
diet.HFD.GTT.lme<-lmer(glucose ~ time + treatment + time:treatment + (1|ID) + (1|dam), data = HFD.GTT.raw.data)
anova(age.HFD.GTT.lme, diet.HFD.GTT.lme)# p=0.87 no effect of treatment
sex.HFD.GTT.lme<-lmer(glucose ~ time + treatment*sex + (1|ID) + (1|dam), data = HFD.GTT.raw.data)
anova(diet.HFD.GTT.lme, sex.HFD.GTT.lme)#significant 
Anova(sex.HFD.GTT.lme)#significant sex:treatment interaction, p=0.011


##Males
HFD.GTT.M<-HFD.GTT.raw.data%>%
  filter(sex == "male")
null.HFD.GTT.lme.m<-lmer(glucose ~ 1 + (1|ID) + (1|dam), data = HFD.GTT.M)
age.HFD.GTT.lme.m <-lmer(glucose ~ time + (1|ID) + (1|dam), data = HFD.GTT.M)
anova(null.HFD.GTT.lme.m, age.HFD.GTT.lme.m)#significant, p=0.0062
diet.HFD.GTT.lme.m<-lmer(glucose ~ time + treatment + time:treatment + (1|ID) + (1|dam), data = HFD.GTT.M)
anova(age.HFD.GTT.lme.m, diet.HFD.GTT.lme.m)# p=0.14
fixef(diet.HFD.GTT.lme.m)
##females
HFD.GTT.F<-HFD.GTT.raw.data%>%
  filter(sex == "female")
null.HFD.GTT.lme.f<-lmer(glucose ~ 1 + (1|ID) + (1|dam), data = HFD.GTT.F)
age.HFD.GTT.lme.f <-lmer(glucose ~ time + (1|ID) + (1|dam), data = HFD.GTT.F)
anova(null.HFD.GTT.lme.f, age.HFD.GTT.lme.f)#significant, p=0.0062
diet.HFD.GTT.lme.f<-lmer(glucose ~ time + treatment + time:treatment + (1|ID) + (1|dam), data = HFD.GTT.F)
anova(age.HFD.GTT.lme.f, diet.HFD.GTT.lme.f)# p=0.61
fixef(diet.HFD.GTT.lme.f)
```

```{r AUC-HFD-GTT}

AUC.GTT.HFD.summary<-HFD.GTT.raw.data%>%
  group_by(treatment, sex)%>%
  summarise_if(is.numeric, .funs = funs(mean=mean(.,na.rm = TRUE),se=se, n=length))
ggplot( AUC.GTT.HFD.summary,aes(treatment, AUC_mean))+
  geom_col(aes(fill = treatment))+
  geom_errorbar(aes(ymin = AUC_mean - AUC_se, ymax = AUC_mean + AUC_se), width = 0.3)+
  facet_grid(.~sex)+
  scale_fill_manual(values = color.scheme )+
  labs(title = "GTT Area Under the Curve", y = " Avg Blood Glucose (mg/dL)")+
   theme(text = element_text(size=16),legend.position = c(0.8,0.19))

##stats
HFD.GTT.AUC.aov<-aov(AUC~sex*treatment, HFD.GTT.raw.data)# effect of interaction
anova(HFD.GTT.AUC.aov)#significant interaction, sex specific needed

#females
HFD.GTT.raw.data.F<-HFD.GTT.raw.data%>%
  filter(sex =="female")

#shapiro.test(HFD.GTT.raw.data.F$AUC[HFD.GTT.raw.data.F$treatment =="eTRF"])#not normal
#shapiro.test(HFD.GTT.raw.data.F$AUC[HFD.GTT.raw.data.F$treatment =="AL"])#not normal
#leveneTest(AUC~treatment, HFD.GTT.raw.data.F)#non-equivalent variance
#Mann-Whitney U test
#wilcox.test(AUC~treatment, HFD.GTT.raw.data.F)#p=0.07
#males
HFD.GTT.raw.data.M<-HFD.GTT.raw.data%>%
  filter(sex =="male")%>%
  group_by(treatment)%>%
  summarize(avg = mean(AUC))

#shapiro.test(HFD.GTT.raw.data.M$AUC[HFD.GTT.raw.data.M$treatment =="eTRF"])#not normal
#shapiro.test(HFD.GTT.raw.data.M$AUC[HFD.GTT.raw.data.M$treatment =="AL"])#not normal
#leveneTest(AUC~treatment, HFD.GTT.raw.data.M)#equivalent variance
#Mann-Whitney U test
#wilcox.test(AUC~treatment, HFD.GTT.raw.data.M)$p.value#p=0.000000096
```

```{r Fig4A}
#Offspring GSIS data
GSIS.file<-"OFF_IV_GSIS.csv"
GSIS.data.raw<-read_csv(GSIS.file,
  col_types = cols(
    Wells = col_factor(levels = NULL),
    ID = col_factor(levels = NULL),
    time = col_integer(),
    diet = col_factor(levels = c("eTRF", "AL")),
    sex  = col_factor(levels = c("female", "male")),
    Raw = col_double(),
    Corrected = col_double(),
    Concs. = col_double(),
    full.conc. = col_double()))

#summary
summary.GSIS<-GSIS.data.raw%>%
  na.omit%>%
  group_by(sex, time, diet)%>%
  summarize_if(is.numeric, .funs = funs(mean=mean(.,na.rm = TRUE),se=se, n=length))

#Plot
color.scheme <- c('gray69','gray36')
ggplot(summary.GSIS, aes(time,full.conc_mean))+
  geom_col(aes(fill = diet), position = position_dodge2())+
  facet_grid(.~sex)+
  geom_errorbar(aes(ymin = full.conc_mean-full.conc_se, ymax = full.conc_mean+full.conc_se), position = position_dodge2())+
   scale_fill_manual(values = c('gray69','gray36'))+
  labs(title = "Glucose Stimulated Insulin Secretion", y = "Insulin (ng/mL)", x = "Time (minutes)")+
   theme(text = element_text(size=16),legend.position = c(0.1,0.8))
##Stats
null.GSIS.lme<-lmer(full.conc~ 1 + (1|ID), GSIS.data.raw)
time.GSIS.lme<-lmer(full.conc~ time + (1|ID), GSIS.data.raw)
anova(null.GSIS.lme, time.GSIS.lme)#sig effect of time p=0.00092
diet.GSIS.lme<- lmer(full.conc~ time + diet + (1|ID), GSIS.data.raw)
anova(time.GSIS.lme, diet.GSIS.lme)# not different with diet, p=0.3
sex.GSIS.lme<-lmer(full.conc~ time + diet*sex + (1|ID), GSIS.data.raw)
anova(diet.GSIS.lme, sex.GSIS.lme)# significantly diff, p=0.00024
Anova(sex.GSIS.lme)# no interaction, effect of time and sex


```
#maternal counts
```{r maternal-info}
MRI.raw.data %>%
  group_by(dam,treatment) %>%
    distinct(dam) %>%
  group_by(treatment)%>%
  count(treatment) %>%
  kable(caption="Dams per feeding group")
```